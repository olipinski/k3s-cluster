{% if longhorn_vars.kubernetes.backup.enabled is truthy %}
defaultBackupStore:
  backupTarget: {{ longhorn_vars.kubernetes.backup.target }}
{% if longhorn_vars.kubernetes.backup.target[:3] | lower != 'nfs' %}
  backupTargetCredentialSecret: {{ longhorn_map.credentials.backup.secret }}
{% endif %}
  pollInterval: {{ longhorn_vars.kubernetes.backup.poll_interval }}
{% endif %}
defaultSettings:
  allowCollectingLonghornUsageMetrics: {{ longhorn_vars.kubernetes.default_settings.collect_usage_metrics | lower }}
  autoCleanupRecurringJobBackupSnapshot: true
  autoCleanupSnapshotWhenDeleteBackup: true
  autoCleanupSystemGeneratedSnapshot: true
  concurrentAutomaticEngineUpgradeLimit: {{ longhorn_vars.kubernetes.default_settings.concurrent_automatic_engine_upgrade_limit }}
  defaultDataLocality: {{ longhorn_vars.kubernetes.default_settings.data_locality }}
  defaultDataPath: {{ longhorn_map.directory.data }}
{% if longhorn_vars.kubernetes.default_settings.volume.replicas < 2 %}
  defaultReplicaCount: 2
{% else %}
  defaultReplicaCount: {{ longhorn_vars.kubernetes.default_settings.volume.replicas }}
{% endif %}
  disableSchedulingOnCordonedNode: true
  logLevel: {{ longhorn_vars.kubernetes.default_settings.log_level }}
  nodeDownPodDeletionPolicy: {{ longhorn_vars.kubernetes.default_settings.pod_deletion_policy }}
  nodeDrainPolicy: {{ longhorn_vars.kubernetes.default_settings.node_drain_policy }}
  orphanAutoDeletion: true
  removeSnapshotsDuringFilesystemTrim: true
  replicaAutoBalance: {{ longhorn_vars.kubernetes.default_settings.volume.replica_auto_balance }}
  # Encryption settings
{% if longhorn_vars.encryption.enabled %}
  csiEncryption: {{ longhorn_vars.kubernetes.default_settings.csi_encryption | lower }}
  csiEncryptionKMSType: {{ longhorn_vars.kubernetes.default_settings.csi_encryption_kms_type }}
  csiEncryptionKMSSecretName: {{ longhorn_vars.kubernetes.default_settings.csi_encryption_kms_secret_name }}
  csiEncryptionKMSSecretNamespace: {{ longhorn_vars.kubernetes.default_settings.csi_encryption_kms_secret_namespace }}
{% endif %}
{% if k3s_vars.cluster.controlplane.tainted is truthy %}
{% if k3s_resources.node.taint.server | length > 0 %}
  taintToleration: {{ k3s_resources.node.taint.server | join | trim }}
{% endif %}
{% if externaldns_vars.cloudflare.host.domain | lower != 'disabled' and longhorn_vars.kubernetes.frontend.ingress.enabled is truthy %}
ingress:
  annotations:
{% for key, value in longhorn_map.gateway.frontend.annotations.items() %}
    {{ key }}: {{ value }}
{% endfor %}
  enabled: true
  host: {{ longhorn_map.gateway.frontend.hostname }}
  ingressClassName: cilium
  pathType: Prefix
  tls: true
  tlsSecret: {{ externaldns_vars.cloudflare.prefix }}-{{ longhorn_vars.kubernetes.frontend.gateway.service }}
{% endif %}
{% if k3s_project.cluster.tolerations | length > 0 %}
longhornDriver:
  tolerations:
    {{ k3s_project.cluster.tolerations | to_nice_yaml(indent=2) | trim | indent(4) }}
longhornManager:
  tolerations:
    {{ k3s_project.cluster.tolerations | to_nice_yaml(indent=2) | trim | indent(4) }}
{% endif %}
{% endif %}

{% set component_monitoring_enabled = longhorn_postinstall is truthy and longhorn_map.metrics.service.monitor.enabled is truthy %}
{% set component_monitoring_interval = longhorn_map.metrics.service.monitor.scrape.interval %}
{% set component_monitoring_timeout = longhorn_map.metrics.service.monitor.scrape.timeout %}
{% include 'templates/common/monitoring.j2' %}

persistence:
{% if longhorn_vars.kubernetes.default_settings.volume.replicas < 2 %}
  defaultClassReplicaCount: 2
{% else %}
  defaultClassReplicaCount: {{ longhorn_vars.kubernetes.default_settings.volume.replicas }}
{% endif %}
  defaultDataLocality: {{ longhorn_vars.kubernetes.default_settings.data_locality }}
  migratable: true
{% endif %}
